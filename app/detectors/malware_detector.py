import hashlib
import magic
from typing import Dict, Optional

class MalwareDetector:
    """Malware detection and file analysis"""
    
    def __init__(self):
        self.known_malware_hashes = set()  # In production, load from database
        self.suspicious_extensions = ['.exe', '.dll', '.bat', '.cmd', '.scr']
        
    def scan_file(self, file_path: str) -> Dict:
        """Scan file for malware"""
        
        # Calculate file hash
        file_hash = self.calculate_hash(file_path)
        
        # Check against known malware
        is_known_malware = file_hash in self.known_malware_hashes
        
        # Analyze file type
        file_type = self.detect_file_type(file_path)
        
        # Calculate risk score
        risk_score = self.calculate_risk_score(file_path, file_type)
        
        return {
            'file_hash': file_hash,
            'file_type': file_type,
            'is_malware': is_known_malware or risk_score > 0.7,
            'risk_score': risk_score,
            'scan_result': 'MALICIOUS' if is_known_malware or risk_score > 0.7 else 
                          'SUSPICIOUS' if risk_score > 0.4 else 'CLEAN'
        }
    
    def calculate_hash(self, file_path: str) -> str:
        """Calculate SHA-256 hash of file"""
        sha256 = hashlib.sha256()
        with open(file_path, 'rb') as f:
            while chunk := f.read(8192):
                sha256.update(chunk)
        return sha256.hexdigest()
    
    def detect_file_type(self, file_path: str) -> str:
        """Detect file type using magic numbers"""
        try:
            mime = magic.Magic(mime=True)
            return mime.from_file(file_path)
        except:
            return 'unknown'
    
    def calculate_risk_score(self, file_path: str, file_type: str) -> float:
        """Calculate risk score for file"""
        score = 0.0
        
        # Check file extension
        if any(file_path.endswith(ext) for ext in self.suspicious_extensions):
            score += 0.3
        
        # Check file entropy (high entropy = possibly packed/encrypted)
        entropy = self.calculate_entropy(file_path)
        if entropy > 7.0:  # High entropy threshold
            score += 0.2
        
        # Check file size (very small or very large can be suspicious)
        # Add more checks as needed
        
        return min(score, 1.0)
    
    def calculate_entropy(self, file_path: str) -> float:
        """Calculate Shannon entropy of file"""
        import math
        from collections import Counter
        
        with open(file_path, 'rb') as f:
            data = f.read()
        
        if not data:
            return 0.0
        
        entropy = 0.0
        counter = Counter(data)
        length = len(data)
        
        for count in counter.values():
            probability = count / length
            entropy -= probability * math.log2(probability)
        
        return entropy
